<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamified Quiz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1, h2 {
            text-align: center;
        }

        .question {
            margin: 20px 0;
        }

        .options {
            list-style: none;
            padding: 0;
        }

        .options li {
            margin: 5px 0;
        }

        .button {
            display: inline-block;
            margin: 20px auto;
            padding: 10px 20px;
            background: #007bff;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
        }

        .button:hover {
            background: #0056b3;
        }

        .result {
            text-align: center;
            margin: 20px 0;
        }

        .download-link {
            color: #28a745;
            text-decoration: none;
            font-weight: bold;
        }

        .download-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gamified Quiz</h1>
        <!-- Login Section -->
        <div id="login-container">
            <h2>Enter Your User ID</h2>
            <input type="text" id="user-id" placeholder="Enter User ID" style="width: 100%; padding: 10px; margin-bottom: 10px;">
            <button id="start-quiz" class="button">Start Quiz</button>
        </div>
        
        <!-- Quiz Section -->
        <div id="quiz-container" style="display: none;">
            <h2 id="quiz-title"></h2>
            <div id="questions"></div>
            <button id="submit-quiz" class="button">Submit Quiz</button>
        </div>
        
        <!-- Result Section -->
        <div id="result-container" class="result" style="display: none;">
            <h2 id="result-message"></h2>
            <a id="download-certificate" class="download-link" href="#" target="_blank">Download Your Certificate</a>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000';
        let userId, quizId = 'quiz1', answers = [];

        // Start Quiz
        document.getElementById('start-quiz').addEventListener('click', () => {
            userId = document.getElementById('user-id').value.trim();
            if (!userId) {
                alert('Please enter your User ID to proceed.');
                return;
            }

            document.getElementById('login-container').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'block';
            fetchQuiz();
        });

        // Fetch Quiz Data
        async function fetchQuiz() {
            try {
                const response = await fetch(`${API_BASE_URL}/get_quiz/${quizId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch quiz data.');
                }
                const quiz = await response.json();
                displayQuiz(quiz);
            } catch (error) {
                console.error('Error fetching quiz:', error);
                alert('Could not load quiz. Please try again.');
            }
        }

        // Display Quiz
        function displayQuiz(quiz) {
            document.getElementById('quiz-title').innerText = quiz.title;
            const questionsDiv = document.getElementById('questions');
            questionsDiv.innerHTML = quiz.questions.map((question, index) => `
                <div class="question">
                    <p>${index + 1}. ${question.question}</p>
                    <ul class="options">
                        ${question.options.map((option, i) => `
                            <li>
                                <label>
                                    <input type="radio" name="question-${index}" value="${i}">
                                    ${option}
                                </label>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `).join('');
        }

        // Submit Quiz
        async function submitQuiz() {
            answers = Array.from(document.querySelectorAll('.question')).map((questionDiv, index) => {
                const selectedOption = questionDiv.querySelector(`input[name="question-${index}"]:checked`);
                return selectedOption ? parseInt(selectedOption.value) : null;
            });

            try {
                const response = await fetch(`${API_BASE_URL}/submit_quiz`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        quiz_id: quizId,
                        user_id: userId,
                        answers: answers
                    })
                });

                const result = await response.json();
                displayResult(result);
            } catch (error) {
                console.error('Error submitting quiz:', error);
                alert('Failed to submit quiz. Please try again.');
            }
        }

        // Display Result
        function displayResult(result) {
            document.getElementById('quiz-container').style.display = 'none';

            const resultContainer = document.getElementById('result-container');
            const resultMessage = document.getElementById('result-message');
            const downloadLink = document.getElementById('download-certificate');

            if (result.certificate && result.certificate !== 'Not awarded') {
                resultMessage.innerText = `Congratulations! You passed with a score of ${result.score}.`;
                downloadLink.href = `${API_BASE_URL}${result.certificate}`;
                downloadLink.style.display = 'inline-block';
            } else {
                resultMessage.innerText = `Sorry, you did not pass. Your score is ${result.score || 0}.`;
                downloadLink.style.display = 'none';
            }

            resultContainer.style.display = 'block';
        }

        // Event Listener for Submit
        document.getElementById('submit-quiz').addEventListener('click', submitQuiz);
    </script>
</body>
</html>
